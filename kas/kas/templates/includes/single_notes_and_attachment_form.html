{% load i18n %}
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="form-row">
        <div class="col-1 ml-auto">
            {% if person_tax_year %}
                <a href="{% url 'kas:person_in_year' object.year object.person.id %}">{% trans 'Tilbage til person' %}</a>
            {% else %}
                <a href="{% url 'kas:policy_detail' object.pk %}">{% trans 'Tilbage til police' %}</a>
            {% endif %}
        </div>
    </div>
    <h1>{{ header }}</h1>
    <h2 id="Note">{% trans 'Notat' %} {% include 'includes/help_text/question_mark.html' with target_id='js-note-collapse' only %}</h2>
    {% include 'includes/help_text/collapse.html' with help_text=notes_helptext target_id='js-note-collapse' only %}
    {{ form.note }}
    <h2 id="Bilag">{% trans 'Bilag' %} {% include 'includes/help_text/question_mark.html' with target_id='js-billag-collapse' only %}</h2>
    {% include 'includes/help_text/collapse.html' with help_text=bilag_helptext target_id='js-billag-collapse' %}
    <div class="form-row form-group">
        <div class="col">
            {{ form.attachment_description }}
        </div>
        <div class="col">
            {{ form.attachment }}
        </div>
    </div>
    {% if form.slutlignet or form.efterbehandling or form.next_processing_date %}
        <div class="form-row">
            {% if form.slutlignet %}
                <div class="form-check mt-3 ml-auto">
                    {{ form.slutlignet }}
                    <label class="form-check-label">{{ form.slutlignet.label }}</label>
                </div>
            {% endif %}
            {% if form.efterbehandling %}
                <div class="form-check mt-3 ml-5">
                    {{ form.efterbehandling }}
                    <label class="form-check-label">{{ form.efterbehandling.label }}</label>
                </div>
            {% endif %}
            {% if form.next_processing_date %}
            <div class="form-check mt-3 ml-5">
                <button id="collapseButtonNextProcessingDate" class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseNextProcessingDate" aria-expanded="false"  aria-controls="collapseNextProcessingDate">
                    {% trans 'Opdatér næste behandlingsdato' %}
                </button>
                <div id="collapseNextProcessingDate" class="collapse">
                    {{ form.next_processing_date }}
                </div>
            </div>
            {% endif %}
        </div>
    {% endif %}
    <div class="form-row">
        <div class="ml-auto">
            <button type="submit" class="btn btn-success mt-2 mb-5">{% trans 'Gem' %}</button>
        </div>
    </div>
</form>


{% if form.slutlignet or form.next_processing_date %}
{{ object.next_processing_date|json_script:"next_processing_date" }}
{{ form.next_processing_date.id_for_label|json_script:"next_processing_date_id" }}
{{ form.slutlignet.id_for_label|json_script:"slutlignet_id" }}
<script>
    const objectNextProcessingDate = JSON.parse($('#next_processing_date').text());
    const nextProcessingDateFieldId = JSON.parse($('#next_processing_date_id').text());
    const slutlignetFieldId = JSON.parse($('#slutlignet_id').text());
</script>
{% endif%}

{% if form.slutlignet %}
{% include 'includes/processing_date_warning.html' with modal_id='processingWarningModal' checkbox_id=form.slutlignet.id_for_label %}
<script>
    if (slutlignetFieldId) {
        $(function(){
            const nextProcessingDateField = nextProcessingDateFieldId ? $("#"+nextProcessingDateFieldId) : null;
            const slutlignetField = $("#" + slutlignetFieldId);
            slutlignetField.change(function () {
                if ($(this).prop("checked")) {
                    const next_processing_date_str = (nextProcessingDateField && !nextProcessingDateField.attr("disabled")) ? nextProcessingDateField.val() : objectNextProcessingDate;
                    if (next_processing_date_str) {
                        const next_processing_date_arr = next_processing_date_str.split("-");
                        const next_processing_date = new Date(next_processing_date_arr[0], next_processing_date_arr[1] - 1, next_processing_date_arr[2]);
                        const current_date = new Date();
                        if (next_processing_date > current_date) {
                            $(this).prop("checked", false);
                            $('#processingWarningModal').modal({});
                        }
                    }
                }
            });
        });
    }
</script>
{% endif %}


{% if form.next_processing_date %}
<script>
    if (nextProcessingDateFieldId) {
        $(function () {
            const nextProcessingDateField = $("#" + nextProcessingDateFieldId);
            $('#collapseNextProcessingDate').on({
                'shown.bs.collapse': function () {
                    // Update processing date field to 30 days in the future if it is not already set
                    if (!objectNextProcessingDate) {
                        var processingDate = new Date();
                        // Adding a number to the days field automatically updates months and years as needed
                        processingDate.setDate(processingDate.getDate() + 30);
                        nextProcessingDateField.val(processingDate.toISOString().split('T')[0]);
                    }
                },
                'hidden.bs.collapse': function () {
                    nextProcessingDateField.val(objectNextProcessingDate);
                }
            });
        });
    }
</script>
{% endif %}
