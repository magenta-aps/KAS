{% load i18n %}
    <form id="notes-and-documents-form" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-row">
            <div class="col-1 ml-auto">
                {% if policy_tax_year %}
                    <a href="{% url 'kas:policy_detail' policy_tax_year.pk %}">{% trans 'Tilbage til police' %}</a>
                {% else %}
                    <a href="{% url 'kas:person_in_year' person_tax_year.year person_tax_year.person_id %}">{% trans 'Tilbage til person' %}</a>
                {% endif %}
            </div>
        </div>
        <div class="form-row">
            {% for field in form %}
                {% if field.name != 'next_processing_date' %}
                <div class="col form-group">
                    <label class="">{{ field.label }}:</label>{{ field }}
                </div>
                {% endif %}
            {% endfor %}
        </div>

        {% if form.next_processing_date %}
        <div class="form-row">
            <div>
                <button id="collapseButtonNextProcessingDate" class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseNextProcessingDate" aria-expanded="false"  aria-controls="collapseNextProcessingDate">
                    {% trans 'Opdatér næste behandlingsdato' %}
                </button>
                <div id="collapseNextProcessingDate" class="collapse">
                    {{ form.next_processing_date }}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="form-row mt-2 mb-2">
            <div class="col">
                {{ notes_formset }}
            </div>
        </div>
        {{ upload_formset.management_form }}
        {% for upload_form in upload_formset  %}
            <div class="form-row mt-2" id="upload-row">
                <div class="col">
                    {{ upload_form.description }}
                </div>
                <div class="col">
                    {{ upload_form.file }}
                </div>
            </div>
        {% endfor %}

    <div class="form-row mt-5">
        <div class="col">
            <input id="add-attachments" class="btn btn-primary" type="button" value="{% trans 'Tilføj flere billag' %}"/>
        </div>
    </div>
    <div class="form-row mt-5">
        <div class="col">
            <input class="btn btn-success float-right" type="submit" value="{% if create %}{% trans 'Opret' %}{% else %}{% trans 'Gem' %}{% endif %}"/>
        </div>
    </div>
</form>
{{ form.next_processing_date.id_for_label|json_script:"next_processing_date_id" }}
<script>
    $( document ).ready(function() {
        $( "input#add-attachments" ).click(function() {
            let count = $('input#id_uploads-TOTAL_FORMS').val();
            let row = `<div class="form-row mt-2">
                <div class="col">
                    <input type="text" name="uploads-${count}-description" placeholder="Fil-beskrivelse" autocomplete="off" class="form-control mr-2" id="id_uploads-${count}-description">
                </div>
                <div class="col">
                    <input type="file" name="uploads-${count}-file" class="form-control mr-2" id="id_uploads-${count}-file">
                </div>
            </div>`
            $(row).appendTo($("form#notes-and-documents-form"))
            $('input#id_uploads-TOTAL_FORMS').val(count+1);
        });

        // Don't submit date field if it's hidden
        const nextProcessingDateField = $("#" + JSON.parse($('#next_processing_date_id').text()));
        $('#collapseNextProcessingDate').on({
            'shown.bs.collapse': function() {
                nextProcessingDateField.removeAttr("disabled");
            },
            'hidden.bs.collapse': function() {
                nextProcessingDateField.attr("disabled", "disabled");
            }
        });
    })
</script>

{% if form.next_processing_date %}
{{ object.next_processing_date|json_script:"next_processing_date" }}
{{ form.next_processing_date.id_for_label|json_script:"next_processing_date_id" }}
<script>
    const objectNextProcessingDate = JSON.parse($('#next_processing_date').text());
    const nextProcessingDateFieldId = JSON.parse($('#next_processing_date_id').text());
    if (nextProcessingDateFieldId) {
        $(function () {
            const nextProcessingDateField = $("#" + nextProcessingDateFieldId);
            $('#collapseNextProcessingDate').on({
                'shown.bs.collapse': function () {
                    // Update processing date field to 30 days in the future if it is not already set
                    if (!objectNextProcessingDate) {
                        var processingDate = new Date();
                        // Adding a number to the days field automatically updates months and years as needed
                        processingDate.setDate(processingDate.getDate() + 30);
                        nextProcessingDateField.val(processingDate.toISOString().split('T')[0]);
                    }
                },
                'hidden.bs.collapse': function () {
                    nextProcessingDateField.val(objectNextProcessingDate);
                }
            });
        });
    }
</script>
{% endif %}
